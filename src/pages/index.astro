---
// src/pages/index.astro
// Homepage mono-niche — template reutilisable
import { getCollection } from 'astro:content';
import SEOHead from '../components/SEOHead.astro';
import Navigation from '../components/Navigation.astro';
import CookieConsent from '../components/CookieConsent.astro';
import NewsletterSignup from '../components/NewsletterSignup.astro';
import { calculateReadingTime } from '../utils/readingTime';
import { siteConfig } from '../data/site-config';
import '../styles/global.css';

// Recuperation et tri de tous les articles
const allArticles = await getCollection('articles');
const allSorted = [...allArticles].sort(
  (a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

const totalArticles = allArticles.length;

// Article vedette : le plus recent
const featuredArticle = allSorted[0];
const featuredSlug = featuredArticle?.id.replace(/\.md$/, '');

// Articles "Les plus lus" : les 4 plus recents (hors vedette)
const topArticles = allSorted.filter(a => a.id !== featuredArticle?.id).slice(0, 4);

// Tous les articles (hors vedette) pour la grille principale
const gridArticles = allSorted.filter(a => a.id !== featuredArticle?.id);
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <SEOHead
    title={`${siteConfig.nicheLabel} — Guides et reponses`}
    description={siteConfig.nicheDescription}
  />
</head>
<body class="min-h-screen">
  <Navigation />

  <!-- Header editorial -->
  <section class="max-w-6xl mx-auto px-4 pt-12 pb-8">
    <h1 class="font-display text-5xl font-bold text-warm-900 mb-3">{siteConfig.name}</h1>
    <p class="text-lg text-warm-500 mb-8 max-w-2xl">
      {siteConfig.description}
    </p>
    <div class="flex items-center gap-6 text-sm">
      <div>
        <span class="font-display text-2xl font-bold text-warm-900">{totalArticles}</span>
        <span class="text-warm-400 ml-1">articles</span>
      </div>
      <span class="w-px h-8 bg-warm-200" aria-hidden="true"></span>
      <div>
        <span class="font-display text-2xl font-bold text-warm-900">{siteConfig.nicheLabel}</span>
      </div>
      <span class="w-px h-8 bg-warm-200" aria-hidden="true"></span>
      <div>
        <span class="font-display text-2xl font-bold text-warm-900">Gratuit</span>
      </div>
    </div>
  </section>

  <!-- Article vedette -->
  {featuredArticle && (
    <section class="max-w-6xl mx-auto px-4 mb-16">
      <div class="hero-featured bg-gradient-to-br from-niche-600 via-niche-700 to-niche-900">
        <div class="hero-featured-overlay"></div>
        <div class="hero-featured-content">
          <span class="hero-featured-badge bg-niche-500">
            {siteConfig.nicheLabel}
          </span>
          <h2>{featuredArticle.data.title}</h2>
          <p>{featuredArticle.data.description}</p>
          <a href={`/${featuredSlug}`} class="hero-featured-cta">
            Lire l'article
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- Section "Les plus lus" -->
  {topArticles.length > 0 && (
    <section class="bg-warm-50 py-10 mb-16">
      <div class="max-w-6xl mx-auto px-4">
        <h2 class="font-display text-2xl font-bold text-warm-900 mb-6">Les plus lus</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {topArticles.map(article => {
            const slug = article.id.replace(/\.md$/, '');
            const readTime = calculateReadingTime(article.body || '');
            return (
              <a href={`/${slug}`} class="article-card">
                <div class="article-card-accent"></div>
                <div class="article-card-body">
                  <span class="article-card-niche">
                    <span class="inline-flex items-center gap-1">
                      <Fragment set:html={siteConfig.nicheIcon} />
                      {siteConfig.nicheLabel}
                    </span>
                  </span>
                  <h3 class="article-card-title">{article.data.title}</h3>
                  <span class="article-card-reading-time">{readTime} min de lecture</span>
                </div>
              </a>
            );
          })}
        </div>
      </div>
    </section>
  )}

  <!-- Tous les articles -->
  <main class="max-w-6xl mx-auto px-4 pb-16">
    {gridArticles.length > 0 && (
      <section>
        <div class="section-header">
          <div>
            <h2 class="section-title">Tous les articles</h2>
            <p class="section-subtitle">{siteConfig.nicheDescription}</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {gridArticles.map((article, index) => {
            const slug = article.id.replace(/\.md$/, '');
            const readTime = calculateReadingTime(article.body || '');
            return (
              <a
                href={`/${slug}`}
                class={`article-card fade-in-up stagger-${Math.min(index + 1, 6)}`}
              >
                <div class="article-card-accent"></div>
                <div class="article-card-body">
                  <span class="article-card-niche">
                    <span class="inline-flex items-center gap-1">
                      <Fragment set:html={siteConfig.nicheIcon} />
                      {siteConfig.nicheLabel}
                    </span>
                  </span>
                  <h3 class="article-card-title">{article.data.title}</h3>
                  <p class="article-card-desc">{article.data.description}</p>
                  <span class="article-card-reading-time">{readTime} min de lecture</span>
                  <time
                    class="article-card-date"
                    datetime={article.data.publishDate.toISOString()}
                  >
                    {article.data.publishDate.toLocaleDateString('fr-FR', {
                      day: 'numeric',
                      month: 'long',
                      year: 'numeric',
                    })}
                  </time>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}
  </main>

  <!-- Newsletter -->
  <NewsletterSignup variant="homepage" />

  <!-- Footer -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <div class="site-footer-grid">
        <div>
          <p class="site-footer-logo">{siteConfig.name}</p>
          <p class="text-sm text-warm-400">
            {siteConfig.description}
          </p>
        </div>

        <div>
          <h3 class="site-footer-heading">Informations</h3>
          <a href="/mentions-legales" class="site-footer-link">Mentions legales</a>
          <a href="/a-propos" class="site-footer-link">A propos</a>
          <a href="/contact" class="site-footer-link">Contact</a>
          <a href="/sitemap-index.xml" class="site-footer-link">Plan du site</a>
        </div>
      </div>

      <div class="site-footer-bottom">
        <p>&copy; {new Date().getFullYear()} {siteConfig.name}. Tous droits reserves.</p>
      </div>
    </div>
  </footer>

  <CookieConsent />
</body>
</html>
