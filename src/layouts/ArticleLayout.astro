---
// src/layouts/ArticleLayout.astro
// Layout article mono-niche â€” la niche vient de siteConfig
import SEOHead from '../components/SEOHead.astro';
import FAQSchema from '../components/FAQSchema.astro';
import Navigation from '../components/Navigation.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import TableOfContents from '../components/TableOfContents.astro';
import ShareButtons from '../components/ShareButtons.astro';
import NewsletterSignup from '../components/NewsletterSignup.astro';
import AdSlot from '../components/AdSlot.astro';
import AffiliateLink from '../components/AffiliateLink.astro';
import RelatedArticles from '../components/RelatedArticles.astro';
import CookieConsent from '../components/CookieConsent.astro';
import { defaultAffiliates } from '../data/affiliates';
import { siteConfig } from '../data/site-config';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  publishDate: Date;
  updatedDate?: Date;
  faq?: { q: string; a: string }[];
  affiliateProducts?: { name: string; link: string; description: string }[];
  relatedSlugs?: string[];
  headings: { depth: number; slug: string; text: string }[];
  currentSlug: string;
  readingTime?: number;
}

const {
  title, description, publishDate, updatedDate,
  faq, affiliateProducts, relatedSlugs, headings, currentSlug, readingTime,
} = Astro.props;

// Logique hybride : frontmatter > config par defaut
const resolvedProducts = affiliateProducts && affiliateProducts.length > 0
  ? affiliateProducts
  : defaultAffiliates;

const AD_CLIENT = siteConfig.adsenseId || '';
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <SEOHead
    title={title}
    description={description}
    publishDate={publishDate}
    updatedDate={updatedDate}
  />
  {faq && faq.length > 0 && <FAQSchema faq={faq} />}
</head>
<body class="min-h-screen">
  <Navigation />
  <ReadingProgress />

  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- Fil d'Ariane -->
    <Breadcrumbs items={[
      { label: 'Accueil', href: '/' },
      { label: title, href: Astro.url.pathname },
    ]} />

    <div class="lg:flex lg:gap-8">
      <!-- Contenu principal -->
      <article class="lg:flex-1 min-w-0 bg-white rounded-2xl overflow-hidden" style="border: 1px solid rgba(0,0,0,0.06); box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
        <!-- Barre d'accent coloree -->
        <div class="article-accent"></div>

        <div class="p-6 md:p-10">
          <!-- En-tete de l'article -->
          <header class="mb-8 pb-6" style="border-bottom: 1px solid rgba(0,0,0,0.06);">
            <!-- Badge niche -->
            <span class="niche-badge">
              <Fragment set:html={siteConfig.nicheIcon} />
              <span class="ml-1.5">{siteConfig.nicheLabel}</span>
            </span>

            <!-- Titre -->
            <h1 class="font-display mt-4 mb-3 leading-tight">{title}</h1>

            <!-- Description -->
            <p class="text-lg text-warm-500 mb-4">{description}</p>

            <!-- Meta : date de publication et mise a jour -->
            <div class="reading-meta">
              <span class="flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                <time datetime={publishDate.toISOString()}>
                  {publishDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}
                </time>
              </span>
              {readingTime && (
                <span class="flex items-center gap-1.5">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  {readingTime} min de lecture
                </span>
              )}
              {updatedDate && (
                <span class="flex items-center gap-1.5 text-niche-600">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                  Mis a jour le {updatedDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}
                </span>
              )}
            </div>
          </header>

          <!-- Boutons de partage -->
          <ShareButtons title={title} url={Astro.url.href} />

          <!-- Sommaire -->
          <TableOfContents headings={headings} />

          <!-- Pub inline haut -->
          <AdSlot slot="inline" adClient={AD_CLIENT} />

          <!-- Corps de l'article -->
          <div class="prose prose-lg max-w-none prose-h1:font-display prose-h1:text-warm-900 prose-h2:font-display prose-h2:text-warm-900 prose-h3:font-display prose-h3:text-warm-900 prose-h4:font-display prose-h4:text-warm-900 prose-th:text-white">
            <slot />
          </div>

          <!-- Encart affiliation -->
          {resolvedProducts.length > 0 && (
            <AffiliateLink products={resolvedProducts} />
          )}

          <!-- FAQ -->
          {faq && faq.length > 0 && (
            <section class="mt-10 pt-8" style="border-top: 1px solid rgba(0,0,0,0.06);">
              <h2 class="text-xl font-semibold mb-6 mt-0 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-warm-400"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                Questions frequentes
              </h2>
              <div class="space-y-3">
                {faq.map(item => (
                  <details class="faq-item">
                    <summary>
                      {item.q}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-warm-400 transition-transform duration-200 flex-shrink-0"><polyline points="6 9 12 15 18 9"/></svg>
                    </summary>
                    <p>{item.a}</p>
                  </details>
                ))}
              </div>
            </section>
          )}

          <!-- Newsletter -->
          <NewsletterSignup />

          <!-- Pub inline bas -->
          <AdSlot slot="bottom" adClient={AD_CLIENT} />
        </div>

        <!-- Articles lies -->
        <div class="px-6 md:px-10 pb-8">
          <RelatedArticles
            currentSlug={currentSlug}
            relatedSlugs={relatedSlugs}
          />
        </div>
      </article>

      <!-- Sidebar desktop -->
      <aside class="hidden lg:block lg:w-72 lg:flex-shrink-0">
        <div class="sticky top-20 space-y-6">
          <AdSlot slot="sidebar" adClient={AD_CLIENT} />
        </div>
      </aside>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <div class="site-footer-bottom">
        <p>&copy; {new Date().getFullYear()} {siteConfig.name}. Tous droits reserves.</p>
        <div class="flex justify-center gap-4 mt-2">
          <a href="/mentions-legales" class="site-footer-link">Mentions legales</a>
          <a href="/a-propos" class="site-footer-link">A propos</a>
          <a href="/contact" class="site-footer-link">Contact</a>
          <a href="/sitemap-index.xml" class="site-footer-link">Plan du site</a>
        </div>
      </div>
    </div>
  </footer>

  <CookieConsent />
</body>
</html>
